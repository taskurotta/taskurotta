<div page-header="Actors" ng-dblclick="$debug = !$debug">
    <div ng-if="$debug">
        <h6>{{ formParams }}</h6>
        <h6>{{ resourceParams }}</h6>
    </div>
</div>

<div page-form="Actors search form">
    <div class="control-group" ng-if="metrics.length">
        <label class="control-label">Select metrics to show:</label>
        <div class="controls">
             <label class="checkbox inline inline-label" ng-repeat="metric in metrics">
                 <input ng-show="!formParams.metrics[metric] || formParams.metrics[metric]==='hour'"
                        type="checkbox" ng-model="formParams.metrics[metric]" ng-true-value="'hour'"/>
                 <input ng-show="formParams.metrics[metric]==='day'"
                        type="checkbox" ng-model="formParams.metrics[metric]" ng-true-value="'day'"/>

                {{metric}}
            </label>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label" for="actorId">Actor metrics view:</label>
        <div class="controls">
            <input id="actorId" ng-model="formParams.filter" type="text"
                   class="input-xlarge" on-enter="search()"/>
            <i icon-info="Filter by Actor id *starts with* condition" model="formParams.filter" remove="formParams.filter = null"></i>
            <button class="btn" ng-click="search()">Search</button>
        </div>
    </div>
</div>

<page-message></page-message>

<div class="well">
    <list-reload  model="actorsResource">
    </list-reload>

    <div style="overflow: auto;">
        <table class="table table-striped table-bordered table-items">
            <thead>
                <tr>
                    <th style="width:35px;">â„–
                    </th>
                    <th>Actor id:</th>
                    <th ng-show="resourceParams.metrics[metric]" ng-repeat="metric in metrics" style="min-width:190px;">
                       {{metric}}
                        <select style="width:90px;" class="btn btn-mini"
                                ng-model="resourceParams.metrics[metric]" ng-change="changeStateParams()">
                            <option value="hour">Last hour</option>
                            <option value="day">Last day</option>
                        </select>
                    </th>
                    <th width="80px;">
                        Actions:
                    </th>
                </tr>
            </thead>

            <tbody>
                <tr ng-repeat="actor in actorsModel.items" ng-class="{error: actor.blocked}">
                    <td>
                        {{ actorsModel.$startIndex + $index }}
                        <i class="icon-ban-circle" ng-if="actor.blocked" style="width:25px; height:25px;cursor:help;" popover="Blocked: 'poll' and 'release' requests for this actor are rejected." popover-trigger="mouseenter"></i>
                    </td>
                    <td>
                        <span ng-bind-html="actor.id | lineWrap"></span>
                    </td>
                    <td ng-show="resourceParams.metrics[metric]" ng-repeat="metric in metrics" >
                        <div ng-repeat="(nodeName, nodeItem) in metricsModel">
                            <hr ng-if="!$first" />
                            <table class="inner-table">
                                <tr>
                                    <td style="width: 80px;"><i class="muted">Node:</i></td>
                                    <td>{{nodeName}}</td>
                                </tr>
                                <tr ng-show="nodeItem.lastActivity">
                                    <td><i class="muted">Last activity:</i></td>
                                    <td> {{nodeItem.lastActivity | date:dateTimeFormat }}</td>
                                </tr>
                                <tr>
                                    <td><i class="muted">Rate({{ resourceParams.metrics[metric] }}):</i></td>
                                    <td>
                                        <span ng-if="actor.queueState && resourceParams.metrics[metric] === 'hour' &&
                                            (actor.queueState.totalOutHour>=0 || actor.queueState.totalInHour>=0)">
                                            <b ng-if="actor.hourRate>0" style="color: red;cursor: help;" popover="Possible performance problems: mean outcome < mean income" popover-trigger="mouseenter">&#x25B2;{{actor.hourRate}}</b>
                                            <b ng-if="actor.hourRate<=0" style="color: green;cursor: help;" popover="Actor is OK" popover-trigger="mouseenter">&#x25BC;{{actor.hourRate}}</b>
                                            in: <b ng-if="actor.queueState.totalInHour>=0">{{actor.queueState.totalInHour}}</b>, out: <b ng-if="actor.queueState.totalOutHour>=0">{{actor.queueState.totalOutHour}}</b>
                                        </span>

                                        <span ng-if="actor.queueState && resourceParams.metrics[metric] === 'day' &&
                                            (actor.queueState.totalOutDay>=0 || actor.queueState.totalInDay>=0)">
                                            <b ng-if="actor.dayRate>0" style="color: red;" popover="Possible performance problems: mean outcome < mean income" popover-trigger="mouseenter">&#x25B2;{{actor.dayRate}}</b>
                                            <b ng-if="actor.dayRate<=0" style="color: green;" popover="Actor is OK" popover-trigger="mouseenter">&#x25BC;{{actor.dayRate}}</b>
                                            in: <b ng-if="actor.queueState.totalInDay>=0">{{actor.queueState.totalInDay}}</b>, out: <b ng-if="actor.queueState.totalOutDay>=0">{{actor.queueState.totalOutDay}}</b>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="muted">Stats:</i></td>
                                    <td>
                                        <div ng-if="resourceParams.metrics[metric] === 'hour'">
                                            Triggered: <b>{{nodeItem.totalCountsHour || 'n/a'}}</b> times<br />
                                            Average: <b>{{nodeItem.meanTimeHour || 'n/a'}}</b> ms
                                        </div>

                                        <div ng-if="resourceParams.metrics[metric] === 'day'">
                                            Triggered: <b>{{nodeItem.totalCountsDay || 'n/a'}}</b> times <br />
                                            Average: <b>{{nodeItem.meanTimeDay || 'n/a'}}</b> ms
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </td>
                    <td>
                        <button ng-show="actor.blocked" class="btn btn-mini" ng-click="unblock(actor)" popover="Unblock actor" popover-trigger="mouseenter">
                            <i class="icon-play-circle" ></i>
                        </button>
                        <button ng-hide="actor.blocked" class="btn btn-mini" ng-click="block(actor)" popover="Block actor" popover-trigger="mouseenter">
                            <i class="icon-ban-circle" ></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <table style="width: 100%">
        <tfoot>
            <tr>
                <td>
                    <list-paginator model="actorsModel">
                    </list-paginator>
                </td>
            </tr>
        </tfoot>
    </table>

</div>
